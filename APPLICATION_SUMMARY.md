# D&D Meta Game - Application Summary

A comprehensive D&D 5e campaign management and AI-powered narrative generation tool that works both online (Claude API) and offline (Ollama).

---

## Table of Contents

1. [Core Systems](#core-systems)
2. [Character Management](#1-character-management)
3. [AI Dungeon Master Sessions](#2-ai-dungeon-master-sessions)
4. [Meta Adventure System](#3-meta-adventure-system)
5. [Companion System](#4-companion-system)
6. [Downtime Activities](#5-downtime-activities)
7. [Story Thread System](#6-story-thread-system)
8. [In-Game Clock](#7-in-game-clock)
9. [Campaign Continuity](#8-campaign-continuity)
10. [Campaign Management](#9-campaign-management)
11. [Quest System](#10-quest-system)
12. [Location System](#11-location-system)
13. [Narrative Event System](#12-narrative-event-system)
14. [Faction System](#14-faction-system)
15. [World Events System](#15-world-events-system)
16. [Travel System](#16-travel-system)
17. [Living World System](#17-living-world-system)
18. [AI Content Generation](#18-ai-content-generation)
19. [Technical Architecture](#technical-architecture)
20. [Key User Flows](#key-user-flows)

---

## Core Systems

### 1. Character Management

#### Core Character Creation & Development
- **Full D&D 5e character sheets** with 50+ attributes including:
  - Basic info: name, first/last name, nickname, gender, race, subrace
  - Class system with multiclass support
  - Level progression (1-20) with experience tracking
  - Ability scores (STR, DEX, CON, INT, WIS, CHA) with modifiers
  - HP management (current/max)
  - Armor class and speed
  - Skills and proficiencies
  - Background and personality traits (ideals, bonds, flaws)
  - Physical appearance (height, weight, age, hair/eye/skin colors)
  - Alignment and faith
  - Equipment and inventory system
  - Avatar/character portraits

#### Advanced Leveling System
- **Multiclass Support**: Characters can combine multiple classes (e.g., Fighter 5 / Rogue 2)
- **Class-specific progression**: Each class has unique features at each level
- **Ability Score Improvements (ASI)**: Automatic detection and implementation at appropriate levels
- **Subclass selection**: Prompts for subclass choice at the appropriate level for each class
- **Hit Dice management**: Tracks hit dice breakdown for multiclass characters
- **Spell slot tracking**: Manages spell slots per level and class
- **Cantrips and spells**: Tracks known/prepared spells per class

#### Spell Management
- Spell slot tracking by level (1-9)
- Short and long rest mechanics (Warlock special rules)
- Spell slot usage and restoration
- Arcane Recovery and other class abilities

#### Character Progression Utilities
- **Rest mechanics**: Short rest (1 hour) and long rest (8 hours) with proper D&D 5e rules
- **XP tracking**: Experience points with level-based thresholds
- **Inventory management**: Track items and equipment
- **Gold management**: Copper, silver, and gold pieces with separate starting gold tracking
- **Faction standings**: Track relationships with organizations
- **Debuffs and injuries**: Status effects and temporary conditions
- **Campaign notes**: Auto-generated notes from session history with player-editable sections

#### Character Reset Options
- **XP Reset**: Clear experience points
- **Full Reset**: Reset HP, gold, inventory, and clear all adventures

---

### 1b. Backstory Parser

#### AI-Powered Backstory Analysis
- **Freeform backstory parsing**: AI analyzes narrative backstory text and extracts structured elements
- **Extracted element types**:
  - Characters (NPCs, mentors, family, enemies)
  - Locations (hometown, birthplace, current, visited, significant)
  - Factions (guilds, organizations, orders)
  - Events (formative moments, conflicts, turning points)
  - Story hooks (unresolved threads, goals, mysteries)
- **Manual editing**: Players can add, remove, or modify parsed elements
- **Re-parse preservation**: Re-parsing preserves manual edits
- **Campaign integration**: Parsed backstory feeds into campaign plan generation and starting location auto-detection

---

### 1c. Campaign Plan System

#### AI-Generated Living World Plans
- **Claude Opus generation**: Comprehensive campaign plans generated by Claude Opus
- **Plan components**:
  - Main quest arc (title, summary, hook, stakes, 3-act structure)
  - NPCs (6-8 characters with descriptions, roles, motivations, secrets)
  - Potential companions (3-4 recruitable allies)
  - Locations (5-6 key locations with descriptions)
  - Factions (3-4 organizations with goals and allegiances)
  - World timeline (events happening independently of the player)
  - Side quests (4-5 additional adventures)
  - DM notes (tone guidance, twists, backup hooks)
- **Campaign description priority**: The campaign description is the #1 rule â€” main quest fulfills the campaign vision, backstory characters are woven in as supporting elements
- **Spoiler system**: Reddit-style spoiler covers hide DM-sensitive content (NPC roles, faction allegiances, secrets)
- **Regeneration**: Regenerate button to create a fresh plan with confirmation
- **Progress bar**: Animated step-by-step progress during generation
- **Plan editing**: Individual NPCs and world events can be added/edited via API

#### Campaign Plan â†’ DM Session Data Flow
The plan feeds into gameplay sessions through a multi-step pipeline:

1. **`getPlanSummaryForSession()`** condenses the full plan into session context:
   - Main quest title, summary, hook, stakes
   - Current act (Act 1) with title, summary, key events, and resolution
   - Active NPCs (from backstory) with names, roles, and motivations
   - All NPCs (non-backstory) with names, roles, and locations
   - Side quests (first 3)
   - DM notes (tone, twists)
   - Upcoming events and world state

2. **`formatCampaignPlan()`** formats the summary into the AI system prompt:
   - Header: "You MUST use this as your guide for the campaign"
   - Sections for quest, NPCs, locations, side quests, tone
   - Critical rule: "The MAIN QUEST above IS the campaign's story - do NOT create a different one"

3. **`campaignFoundationPrompt`** (conditional):
   - **With plan**: "A CAMPAIGN PLAN has been provided. You MUST use it. DO NOT invent your own antagonist."
   - **Without plan**: "You MUST internally establish a BBEG, story arc, and first clue."

---

### 2. AI Dungeon Master Sessions

#### LLM Provider Support
- **Two-stage AI pipeline**:
  - **Claude Opus** â€” All world building and content generation (campaign plans, backstory parsing, NPC/quest/location/companion generation, living world events, adventures)
  - **Claude Sonnet** â€” Runs interactive DM sessions only (narration, combat, dialogue)
  - Ollama â€” Local fallback with offline support for all tasks
  - Automatic provider detection and fallback
- **Status checking**: Health checks for both providers
- **Status indicator**: Purple "Opus + Sonnet" when Claude connected, green "Ollama" for local

#### Interactive Text Adventure Sessions
- **Real-time conversation-based gameplay**
- **Character message history**: Full conversation saved per session
- **Dynamic narrative generation**: AI generates descriptions and outcomes
- **Session properties**:
  - Title and setting description
  - Tone customization (heroic, dark, comedic, etc.)
  - Content preferences (violence level, romance, language, survival mode)
  - Model selection
- **Session states**: active, paused, completed
- **Reward claiming**: Rewards from sessions can be claimed separately

#### AI DM Prompt System
The system prompt (~600+ lines in `server/services/dmPromptBuilder.js`) enforces D&D 5e rules:

**Absolute Rules (enforced at top AND bottom of prompt via primacy/recency reinforcement)**:
- **ONE QUESTION RULE**: When an NPC asks the player a question, the AI MUST stop narrating and wait for the player's response. No continuing the story past the question.
- **SKILL CHECK = HARD STOP**: When the AI requests any dice roll (skill check, saving throw, attack roll), it MUST stop writing immediately. The roll request is the last sentence â€” no narrating outcomes before the player rolls.
- **COMBAT = DICE ROLLS**: Any attack triggers full combat mechanics â€” initiative, attack rolls, damage rolls, turn order. Even attacks on friendly NPCs or civilians.
- **NPC LOGIC**: NPCs must behave geographically and logically consistently. No contradictory travel, impossible distances, or broken cause-and-effect.
- **STARTING LOCATION**: First session must begin physically in the player's chosen starting location, not skip ahead to Act 1 events.

**Combat Mechanics**:
1. Player declares attack â†’ AI emits `[COMBAT_START: Enemies="..."]` and STOPS
2. System rolls initiative for all combatants (d20 + DEX mod), injects turn order into AI context
3. Combat Tracker bar appears above messages showing round counter and turn order chips
4. On player's turn: "Roll to attack" with target AC
5. Player rolls â†’ AI narrates hit/miss, requests damage roll if hit
6. Full turn-by-turn combat until `[COMBAT_END]` clears the tracker

**Campaign Plan Integration**:
- When a campaign plan exists (generated by Opus), the `campaignFoundationPrompt` tells Sonnet to USE the plan â€” not invent its own story
- When no plan exists, Sonnet establishes its own BBEG and story arc
- `formatCampaignPlan()` includes: main quest, hook, stakes, Act 1 details, all NPCs, side quests, tone guidance
- Header: "You MUST use this as your guide... DO NOT invent your own BBEG"

#### Downtime Detection
When a player's action text matches rest/crafting/training patterns, a "Downtime Activity Detected" modal appears:

**Detection patterns** (word-boundary protected to prevent false positives):
- **Rest**: "take a long rest", "I sleep", "take first watch", "through the night", "bed down", "call it a night"
- **Training**: "I train", "practice", "spar"
- **Crafting**: "I craft a sword", "forge", "brew a potion" (requires craftable object)
- **Study**: "I study", "research", "pore over tomes"
- **Work**: "I look for work", "earn gold", "odd jobs"

Auto-classifies as short/long rest and detects duration from text.

#### In-Session Downtime Integration
- **Gameplay tabs** (Adventure / Downtime / Stats) during active sessions
- Manual downtime via the Downtime tab injects context into the AI conversation:
  - `POST /:sessionId/inject-context` adds a system note to the session messages
  - AI becomes aware of HP recovery, gold earned, etc.
  - Visual confirmation appears in the chat

#### Session Outcomes
- **Rewards from DM sessions**:
  - XP gained
  - Gold earned
  - Loot acquisition
  - HP changes
- **Location updates**: Sessions can change character location
- **Quest updates**: Sessions can trigger new quests
- **Game time advancement**: Sessions advance in-game time
- **Session recap**: Auto-generated summaries of events
- **NPC extraction**: AI-identified NPCs can be saved to the database

#### Context Awareness
- **Campaign plan injection**: Full Opus-generated world plan fed into system prompt
- **World state snapshot**: Living world data (faction standings, world events, NPC relationships, faction goals, discovered locations) gathered via 5 parallel service queries and compressed into the system prompt at session start
- **Campaign context endpoint**: `/api/dm-session/campaign-context/:characterId` returns plan summary + character state
- **Story thread awareness**: AI knows about active plot threads
- **Pending narratives**: Downtime and adventure events inform DM behavior
- **NPC relationships**: AI aware of character relationships with promises, debts, and secrets
- **Location-aware**: Sessions consider current location and discovered locations
- **Previous session continuity**: Session summaries carry context between sessions

#### Merchant Shopping System
- **Persistent inventories**: Merchants have loot-table-generated inventories stored in the database (not AI-generated per visit)
- **Merchant types**: General store, blacksmith, magic shop, alchemist, jeweler, leatherworker, tailor, scribe, temple
- **Prosperity scaling**: Poor/modest/comfortable/wealthy/aristocratic tiers affect item selection, pricing, quantities, and merchant gold
- **Campaign plan merchants**: Generated scaled by location size (city: 5-8, town: 3-4, village: 1-2)
- **Ad-hoc merchants**: Auto-created when AI emits `[MERCHANT_SHOP]` for an unknown merchant name
- **AI-inventory sync**: When AI detects a merchant, real inventory is injected into conversation so AI references actual items
- **Browse Wares button**: Shows shop UI with real inventory when merchant detected, clears on non-merchant responses
- **Merchant referrals** (`[MERCHANT_REFER]`): AI redirects to another merchant; system guarantees the item exists there
- **Custom items** (`[ADD_ITEM]`): AI adds narrative items with quality tiers (standard 1x, fine 1.5x, superior 2x, masterwork 3x)
- **Buy/sell transactions**: Inventory depletes on purchase, merchant gold limits sales, restock regenerates from loot tables
- **Loot drops** (`[LOOT_DROP]`): AI emits marker when player finds treasure, loots enemies, or receives item rewards â€” items auto-added to character inventory

#### In-Session Stats Bar
At-a-glance character stats displayed in the session info bar:
- **HP**: Color-coded (green >50%, yellow 25-50%, red <25%) with current/max
- **AC**: Armor class with blue accent
- **Gold**: Current gold pieces with gold accent
- Displayed alongside game date, spell slots, and rest buttons

#### In-Session Inventory Panel
Slide-in overlay panel (green `#10b981` accent) accessible via "Inventory" button during sessions:
- **Rarity colors**: Items color-coded by D&D rarity (common/uncommon/rare/very rare/legendary)
- **Filter tabs**: All, Weapons, Armor, Misc
- **Session tracking**: Items gained this session highlighted with "NEW" badge
- **Discard**: Remove items from inventory mid-session
- **Gold display**: gp/sp/cp breakdown
- Batch rarity lookup via `POST /api/dm-session/item-rarity-lookup`
- Discard via `POST /api/character/:id/discard-item`
- Mutual exclusion with Character and Party panels

#### Racial Traits Display
The Abilities tab in the Quick Reference panel shows racial traits:
- Auto-looked up from `races.json` by race/subrace
- Traits displayed as cards with teal accent
- Subraces use their own complete trait arrays

#### Initiative & Combat Tracker
Automatic initiative rolling and visual combat tracking during DM sessions:
- **Markers**: AI DM emits `[COMBAT_START: Enemies="..."]` when combat begins, `[COMBAT_END]` when it ends
- **Server-side initiative**: d20 + DEX modifier for player, companions (from ability scores), and enemies (heuristic estimation)
- **Turn order injection**: Initiative results injected into AI conversation so it follows the established order
- **Visual tracker** (`CombatTracker.jsx`): Inline bar above messages with round counter and combatant chips
  - Player (blue `#60a5fa`), Companions (purple `#9b59b6`), Enemies (red `#ef4444`)
  - Active turn highlighted with gold border (`#fbbf24`)
  - "Next Turn" and "End Combat" control buttons
- **Heuristic DEX**: rogues/assassins +4, wolves/snakes +3, goblins/skeletons +2, bandits/guards +1, ogres/giants -1, default +1
- **3-point prompt reinforcement**: ABSOLUTE RULES + COMBAT section + FINAL REMINDER
- Markers stripped from displayed narrative
- Detection functions: `detectCombatStart()`, `detectCombatEnd()`, `estimateEnemyDexMod()` in `dmSessionService.js`

#### Expanded Loot Systems
- **Session-end loot**: All risk levels can now drop items (high 25%, medium 10%, low 5%) â€” not just high-risk adventures
- **Travel encounter loot**: Auto-generated when resolving encounters â€” combat (30%), discovery (40%), obstacle (10%), etc.
- **DM session loot drops**: AI DM emits `[LOOT_DROP]` markers for combat rewards, hidden treasure, and NPC gifts â€” items added to real inventory
- **Quest completion rewards**: Quest-defined rewards (gold, XP, items) auto-applied when quest completes â€” items are narratively tied to the quest

#### DMG Magic Items & Rarity System
- **~165 D&D 5e items** (DMG + Xanathar's Guide) across 5 rarity tiers: common, uncommon, rare, very rare, legendary
- **Item categories**: Magic weapons, armor, wondrous items, rings, wands/rods/staves, scrolls, potions, gems
- **XGtE common items (~37)**: Fun, flavorful items like Cloak of Billowing, Clockwork Amulet, Hat of Wizardry, Wand of Smiles, Pipe of Smoke Monsters, Veteran's Cane, and more
- **13 cursed items** with disguise system â€” appear as desirable items until identified (e.g., Bag of Devouring appears as Bag of Holding)
- **Prosperity-based magic caps**: Each shop tier limits how many high-rarity items can appear (poor: max 1 uncommon; aristocratic: up to 1 legendary + 2 very rare + 4 rare)
- **Character level gating**: Uncommon 3+, rare 5+, very rare 9+, legendary 13+
- **Weighted selection**: Common 6x, uncommon 3x, rare 1x, very rare 0.5x, legendary 0.25x
- **Cursed item injection**: Prosperity-based chance (2-15%) to replace a real item with a cursed fake
- **AI curse awareness**: Cursed items annotated with `[CURSED: actually X â€” description]` in AI inventory injection; AI instructed not to reveal until Identify/Detect Magic
- **Blacksmith magic pool**: Derived `MAGIC_WEAPONS_ARMOR` pool gives blacksmiths access to magic weapons/armor (gated by prosperity + level)
- **Rarity colors in shop UI**: Uncommon purple, rare blue, very rare bright violet, legendary orange/gold

---

### 3. Meta Adventure System

#### Adventure Generation & Management
- **Intelligent adventure generation** using Claude AI or Ollama with full campaign context
- **Multi-risk adventures**: Generate all risk levels (low, medium, high) in one call
- **Contextual adventure creation**: Uses character location, level, past adventures, and story threads
- **Adventure preview**: See odds of success before committing
- **Adventure properties**:
  - Title and description
  - Location setting
  - Risk level (low/medium/high)
  - Duration in hours
  - Activity type (combat, stealth, investigation, etc.)
  - Quest relevance (side_quest/quest_adjacent/quest_advancing)

#### Adventure Execution & Rewards
- **Time-based resolution**: Adventures complete after elapsed real-world time
- **Success determination**: Based on risk level, party composition, and companion participation
- **Party synergy calculations**: All 13 D&D classes integrated with role-based bonuses
- **Transparent odds display**: See breakdown of success factors before starting
- **Rewards system**:
  - Experience points (scaled by risk and duration)
  - Gold rewards (scaling with level and risk)
  - Loot generation (high 25%, medium 10%, low 5% â€” level-appropriate DMG items)
  - HP restoration on success
- **Consequences on failure**:
  - HP loss
  - Gold loss (percentage-based)
  - Debuffs with duration
- **Story thread creation**: Adventures auto-generate plot hooks and consequences

#### Party Synergy System
- **Class roles defined** for all 13 D&D classes:
  - Barbarian, Bard, Cleric, Druid, Fighter, Monk, Paladin, Ranger, Rogue, Sorcerer, Warlock, Wizard, Artificer
- **Activity-specific synergies**: Different activities benefit from different class combinations
  - Combat, Stealth, Social, Exploration, Arcane, Investigation, Survival, etc.
- **Required vs beneficial roles**: Some activities require certain roles, others just benefit from them
- **Success chance modifiers**: +5% to +15% bonuses for good party composition

---

### 4. Companion System

#### Companion Management
- **Recruitment**: NPCs can be recruited as companions
- **Progression types**:
  - **NPC stats**: Use original CR-based stats (simpler)
  - **Class-based**: Full class progression with leveling (advanced)
- **Companion leveling**: Class-based companions can gain levels
- **Companion HP**: Calculated from class, level, and CON modifier
- **Companion inventory**: Separate inventory and gold tracking
- **Companion skills**: Proficiency tracking
- **Companion spellcasting**: Cantrips and spells known

#### Companion Traits & Details
- Personality traits (trait_1, trait_2)
- Voice and mannerism descriptions
- Motivation and fears
- Alignment, faith, lifestyle
- Ideals, bonds, flaws
- Bonds to party members
- Background and history
- Armor class and speed
- Ability scores (full 6-ability tracking)

#### Party Member Creation
- **Create from scratch**: Build new NPCs as party members directly
- **Appearance customization**: Full physical descriptions
- **Personality system**: Motivation, fears, secrets
- **Starting equipment**: Define equipment and starting gold
- **Class selection**: Choose class and level at creation

#### Companion Status Management
- **Active**: Currently in the party
- **Dismissed**: Can be re-recruited fresh
- **Deceased**: Permanently fallen
- **Campaign availability states**: Available for recruitment, party member, etc.

#### Companion Backstories (Auto-Generated)
When a companion is recruited, an AI-generated backstory is automatically created:
- **Origin story**: Where they came from, early life events
- **Formative event**: Key moment that shaped their personality
- **Unresolved threads**: Personal plot hooks (family, enemies, debts, mysteries)
- **Secrets**: Hidden information revealed at loyalty thresholds
- **Loyalty triggers**: Actions that increase or decrease their loyalty

See [Narrative Event System](#12-narrative-event-system) for details on backstory integration.

#### Adventure Participation
- **Companion participation tracking**: Specific companions can join adventures
- **Synergy bonuses**: Party composition affects success odds
- **XP distribution**:
  - Participating companions get full XP
  - Non-participating get 50% XP
  - Supports full leveling progression
- **Narrative inclusion**: Adventure narratives mention companion contributions

---

### 5. Downtime Activities

#### Activity Types Available
1. **Rest & Sleep**: Short rest (1h) and long rest (8h) with quality modifiers
2. **Pray & Meditate**: Spiritual activities with divine favor chance
3. **Train & Practice**: Combat skill improvement
4. **Study & Read**: Knowledge acquisition and lore learning
5. **Craft & Create**: Item creation and tool use
6. **Work for Hire**: Earn gold through labor
7. **Socialize**: Gather rumors, make contacts
8. **Carouse**: Tavern activities with random events
9. **Maintain Equipment**: Prevent gear degradation

#### Location-Based Activities
- **Settlement activities**: Work, socializing, training
- **Tavern activities**: Carousing, gambling
- **Wilderness activities**: Hunting, foraging, camping
- **Temple activities**: Prayer, meditation
- **Library activities**: Study, research

#### Rest Mechanics
- **Rest quality levels**: Luxurious, comfortable, adequate, poor, terrible
- **Quality modifiers**: Affect HP recovery and ability recharge
- **Rest conditions**: Location keywords determine quality
- **Hit Dice spending**: Short rest allows Hit Dice recovery
- **Spell slot restoration**: Long rest restores all slots

#### Class-Specific Work Options
Each class has 5-6 unique work options with different pay rates and benefits:

| Class | Example Work Options |
|-------|---------------------|
| Cleric | Healing, temple service, preaching, blessing goods |
| Paladin | Guard duty, militia training, mediation |
| Fighter | Guard duty, arena fighting, bounty board work |
| Rogue | Locksmith, spying, street performance, gambling |
| Wizard | Magic item identification, scroll scribing, tutoring |
| Sorcerer | Fortune telling, magical entertainment |
| Warlock | Occult readings, curse consultation |
| Bard | Tavern performance, entertainment, music lessons |
| Ranger | Wilderness guide, hunting, tracking |
| Druid | Animal healing, crop blessing, nature guidance |
| Monk | Martial arts teaching, meditation, courier service |
| Barbarian | Heavy labor, arena fighting, debt collection |
| Artificer | Repair services, crafting, magic item repair |

#### Downtime Rewards & Benefits
- **HP restoration**: Quality-dependent recovery
- **Gold earned**: Class and level scaling
- **XP gained**: Activity-dependent amounts
- **Equipment maintenance**: Prevents degradation
- **Random events**: Rumors, contacts, unusual occurrences
- **Narrative flavor**: Generate descriptive text for rest events

---

### 6. Story Thread System

#### Story Thread Types
- **new_enemy**: A new antagonist or hostile faction (high priority)
- **new_ally**: A potential ally or friendly contact
- **intel**: Valuable information discovered
- **reputation**: How others perceive you has changed
- **resource**: Access to new resources or opportunities
- **mystery**: An unanswered question or unexplained event
- **opportunity**: A time-limited chance to gain something valuable
- **threat**: A danger that will manifest if not addressed
- **relationship**: A shift in relationship with an NPC or faction

#### Thread Properties
- **Title and description**: What is the plot hook about
- **Status**: Active, resolved, expired
- **Priority**: High, normal, low
- **Quest relevance**: side_quest, quest_adjacent, quest_advancing
- **Related NPCs**: Who is involved
- **Related locations**: Where the action takes place
- **Potential outcomes**: How the thread could resolve
- **Expiration date**: When the thread becomes irrelevant
- **Resolution tracking**: How/when the thread was resolved
- **Consequence category**: new_enemy, new_ally, intel, reputation, resource

#### Quest Resolution
- **Quest-resolving threads**: Some threads can resolve current quests
- **Quest completion**: Intel or new_ally consequences on quest-advancing adventures can resolve quests
- **Multi-quest support**: Track multiple parallel quests
- **Auto-generation**: DM sessions and adventures generate threads

#### AI DM Integration
- **Context injection**: Active story threads are included in DM session prompts
- **Narrative weaving**: AI is instructed to incorporate threads into the story
- **Priority weighting**: Higher priority threads are emphasized

---

### 7. In-Game Clock

#### Time Tracking
- **Harptos calendar** tracking (Forgotten Realms standard)
  - Day, month, year
  - Season awareness
  - Time of day (morning, afternoon, evening, night)

#### Configurable Time Ratios
| Mode | In-Game Hours per Real Hour |
|------|----------------------------|
| Narrative | 12 hours |
| Normal | 6 hours |
| Action-packed | 1 hour |
| Slow | 2 hours |

#### Time Advancement
- **Adventures**: Time advances based on adventure duration
- **Downtime**: Activities advance time appropriately
- **DM sessions**: Sessions advance in-game time
- **Manual skips**: Advance time for montages or time jumps

---

### 8. Campaign Continuity

#### Auto-Generated Campaign Notes
- **Session summaries**: Key moments extracted from conversations
- **NPC memory**: Important NPCs and interactions recorded
- **Item tracking**: Notable acquisitions and trades recorded
- **Promise tracking**: Obligations and deals recorded
- **Key events**: Major narrative moments summarized

#### Player-Editable Notes
- **"My Notes" section**: Persists across regenerations
- **Player annotations**: Add personal campaign notes
- **Session observations**: Record important details

---

### 9. Campaign Management

#### Streamlined Campaign Creation
- **Auto-pipeline**: Creating a campaign automatically:
  1. Creates the campaign record
  2. Assigns the current character
  3. Parses backstory (if exists and not already parsed)
  4. Generates the full campaign plan via Claude Opus
- **Progress UI**: Step-by-step progress with checkmarks, spinner, and animated progress bar during generation
- **Play Now**: "Play Now" button appears on completion, navigating directly to the DM session
- **Starting location dropdown**: Grouped select with 15 Forgotten Realms locations (Major Cities + Regions) plus custom option
- **Backstory auto-detection**: Starting location auto-selects from parsed backstory (hometown/birthplace/current)

#### Campaign Properties
- Name and description
- Setting (e.g., Forgotten Realms, Eberron, homebrew)
- Tone (heroic fantasy, dark fantasy, comedic, gritty, whimsical, mysterious, epic, survival)
- Starting location (dropdown with auto-select or custom)
- Time ratio configuration (realtime, leisurely, normal, fast, montage)
- Status tracking (active, archived)
- **Campaign plan** (JSON blob stored in `campaign_plan` column)

#### Campaign Deletion
- **Hard delete** with full cascade cleanup (preserves characters, unassigns them)
- Cleanup order: unassign characters â†’ clear location refs â†’ delete narrative queue â†’ delete journeys â†’ delete world events â†’ delete factions â†’ delete quests â†’ delete locations â†’ delete campaign

#### Campaign Statistics
- Track total quests, locations, characters per campaign
- Aggregate narrative data across sessions
- Campaign-wide event history

#### Play Button (Home Screen)
- Prominent "Play" button on home screen when character has a campaign plan ready
- Checks `/api/campaign/:id/plan` for `main_quest` to determine readiness
- One click to launch DM session

---

### 10. Quest System

#### Multi-Stage Quest Architecture
- **Quest types**:
  - **Main Quests**: 5-stage epic storylines with antagonists and world-changing stakes
  - **Side Quests**: 2-3 stage focused storylines with local impact
  - **One-Time Quests**: Single-objective tasks (bounty, rescue, delivery, retrieval)
  - **Companion Quests**: Personal quests tied to companion backstory threads

#### Quest Properties
- Title, premise, and detailed description
- Quest giver NPC and target/antagonist tracking
- Location associations
- Urgency level (leisure, normal, pressing, urgent, critical)
- Reward tiers (gold, XP, items, reputation)
- Expiration dates for time-sensitive quests
- Tags for categorization and matching

#### Quest Stages
- Sequential stages with names and descriptions
- Each stage has abstract requirements that can be satisfied multiple ways
- Stage completion unlocks the next stage
- Final stage completion resolves the quest

#### Abstract Requirement System
Requirements are **abstract** - they describe what needs to happen, not exactly how:

| Requirement Type | Description | Example |
|------------------|-------------|---------|
| `adventure_completed` | Complete adventures with certain tags | "Complete an investigation adventure" |
| `location_visited` | Visit a specific type of location | "Visit a dungeon" |
| `location_discovered` | Discover a new location | "Find the hidden temple" |
| `npc_interaction` | Interact with specific NPC types | "Speak with a merchant" |
| `item_obtained` | Acquire items with certain tags | "Obtain a magical weapon" |
| `story_thread_resolved` | Resolve a story thread | "Deal with the bandit threat" |
| `companion_recruited` | Recruit a companion | "Find an ally" |
| `gold_spent` | Spend gold on something | "Invest 500 gold" |
| `time_passed` | Wait for time to pass | "Let a week pass" |
| `custom` | Flexible custom conditions | DM discretion |

#### Quest Progress Checking
- **Event-driven progress**: Game events automatically check quest requirements
- **Partial completion**: Requirements track individual completion status
- **Multiple paths**: Same requirement can be satisfied different ways
- **Automatic advancement**: Stage advances when all requirements met

---

### 11. Location System

#### Location Types
- **Cities**: Major settlements with services and NPCs
- **Towns/Villages**: Smaller settlements
- **Dungeons**: Adventure sites with encounters
- **Ruins**: Ancient locations with mysteries
- **Temples/Shrines**: Religious sites
- **Wilderness**: Forests, mountains, plains
- **Fortresses/Castles**: Strongholds
- **Caves/Mines**: Underground locations

#### Location Properties
- Name and detailed description
- Location type and region
- Danger level (1-10 scale)
- Discovery status (unknown, rumored, discovered, visited, explored)
- Visit tracking (times visited, last visit date)
- Associated NPCs (who can be found here)
- Tags for matching and categorization
- Coordinates for mapping (optional)

#### Location Connections
- **Travel routes** between locations
- Connection properties:
  - Distance and travel time
  - Danger level of the route
  - Route type (road, trail, river, teleportation)
  - Requirements (e.g., boat needed, password required)
- Bidirectional or one-way connections
- Discoverable shortcuts

#### Location Discovery Flow
1. Location starts as "unknown"
2. Can become "rumored" through intel
3. Visiting changes to "discovered" then "visited"
4. Full exploration changes to "explored"
5. Dangerous locations (level 3+) auto-generate one-time quests when discovered

---

### 12. Narrative Event System

#### Central Event Bus
A pub/sub event system that connects all game systems:

```
Game Action â†’ Event Emitted â†’ Listeners Triggered â†’ Consequences Applied
```

#### Supported Game Events

| Event | Trigger | Consequences |
|-------|---------|--------------|
| `adventure_complete` | Adventure finishes | Check quest progress, companion triggers |
| `adventure_started` | Adventure begins | Update character state |
| `location_discovered` | New location found | Create quests, update maps |
| `location_visited` | Location entered | Track visits, trigger events |
| `story_thread_created` | Plot hook generated | Add to narrative queue |
| `story_thread_resolved` | Thread concluded | Check quest progress, update reputation |
| `quest_stage_advanced` | Quest progresses | Notify player, unlock content |
| `quest_completed` | Quest finished | Grant rewards, update world state |
| `companion_recruited` | NPC joins party | Generate backstory, add to queue |
| `companion_dismissed` | NPC leaves party | Update availability |
| `companion_loyalty_changed` | Loyalty shifts | Check secret reveals |
| `npc_interaction` | Talk to NPC | Check quest requirements |
| `item_obtained` | Get new item | Check quest requirements |
| `game_time_advanced` | Time passes | Check expirations, trigger events |
| `dm_session_started` | DM session begins | Load narrative context |
| `dm_session_ended` | DM session ends | Process outcomes, check companion triggers |

#### DM Session Event Emission
When a DM session ends, the session-end handler emits gameplay events based on the AI's analysis of the session:
- **NPC interactions** â€” For each NPC extracted from the session transcript
- **Location visits** â€” For locations mentioned in extracted campaign notes
- **Items obtained** â€” For items gained per the inventory analysis
- **Session ended** â€” Triggers companion trigger checker for backstory thread activations

This connects the freeform AI DM gameplay to the structured quest/companion systems.

#### Narrative Queue
A queue of story events waiting to be delivered to the player during DM sessions:

- **Event types**: Quest progress, companion reactions, world changes, warnings
- **Priority levels**: Urgent, high, normal, low, flavor
- **Delivery tracking**: Items marked as delivered after DM mentions them
- **AI context formatting**: Queue items formatted for DM system prompt
- **Session integration**: DM is instructed to weave queue items into narrative

#### Companion Backstory System

**Backstory Components**:
- **Origin**: Where they came from, their early life
- **Formative Event**: Key moment that shaped who they are
- **Motivation**: What drives them now
- **Personality Summary**: Core traits and tendencies

**Unresolved Threads**:
Personal plot hooks that can activate during play:
- Thread types: family, enemy, debt, romance, mystery, vengeance, redemption
- Status: dormant, active, resolved
- Intensity level (1-10)
- Activation triggers (location visits, NPC encounters, events)

**Secrets**:
Hidden information revealed at loyalty thresholds:
- Categories: shameful, dangerous, valuable, tragic, hopeful
- Loyalty threshold required for reveal
- Impact on relationship when revealed

**Loyalty Triggers**:
Actions that increase or decrease companion loyalty:
- Positive triggers (rescue them, support their goals, etc.)
- Negative triggers (betray trust, oppose their values, etc.)

---

### 14. Faction System

#### Faction UI (FactionsPage Component)
Access via the "Factions" button in the header when a character is selected:

**Faction List Panel**:
- View all factions in the current campaign
- See your standing with each faction at a glance
- Color-coded standing indicators (Hated â†’ Exalted)
- Scope badges (local/regional/continental/global)
- Create new factions for your campaign

**Faction Detail Panel**:
- View detailed faction information (stats, alignment, description)
- See active faction goals with progress tracking
- View notable faction members
- Join or leave factions with membership tracking

#### Faction Management
Track organizations that pursue their own goals and interact with the world:

- **Faction properties**:
  - Identity: Name, description, symbol, motto
  - Scope: Local, regional, continental, global
  - Power level (1-10 scale)
  - Influence areas and territory
  - Headquarters location
  - Leadership structure and leader NPC
  - Resources: wealth, military, political, magical, information network

#### Faction Values & Methods
- **Alignment**: Faction's moral alignment
- **Primary values**: What the faction believes in
- **Typical methods**: How they achieve their goals
- **Recruitment requirements**: What it takes to join
- **Membership benefits**: What members receive

#### Faction Goals
Factions actively pursue objectives that can affect the world:

| Property | Description |
|----------|-------------|
| Goal type | Expansion, defense, economic, political, military, covert |
| Progress tracking | 0-100 progress with milestones |
| Urgency level | Critical, high, normal, low |
| Stakes level | Minor, moderate, major, catastrophic |
| Visibility | Public, rumored, secret |
| Targets | Can target locations, factions, NPCs, or characters |
| Consequences | Success and failure outcomes defined |

#### Faction Standings
Track character relationships with factions:

- **Standing levels**: Enemy â†’ Hated â†’ Hostile â†’ Unfriendly â†’ Neutral â†’ Friendly â†’ Honored â†’ Revered â†’ Exalted
- **Standing ranges**: -100 to +100
- **Deed tracking**: Separate lists for deeds for and against the faction
- **Membership system**: Join factions with membership levels
- **Knowledge tracking**: Track known members, known goals, known secrets
- **Quest completion**: Track quests completed for the faction

#### Faction Relationships
- Factions can have relationships with other factions (-100 to +100)
- Relationship status affects world events and opportunities
- Player actions can shift faction relationships

#### Tick Processing
- Faction goals automatically advance over game time
- Progress based on faction power level and goal urgency
- Goals complete when progress reaches maximum
- Completed goals trigger consequences

---

### 15. World Events System

#### World Events UI (WorldEventsPage Component)
Access via the "Events" button in the header when a character is selected:

**Event List Panel**:
- View all world events in the current campaign
- Filter by: Active, All, or Resolved events
- Event type icons with color-coding
- Scope, status, and visibility badges
- Stage progress bars for multi-stage events
- Create new world events

**Event Detail Panel**:
- View detailed event information
- Stage progression with current stage highlighted
- Advance Stage and Resolve Event actions
- Possible outcomes and player intervention options
- Active effects from the event

#### World Event Types
Significant events that affect the game world:

| Event Type | Description |
|------------|-------------|
| Political | Power shifts, treaties, conflicts |
| Economic | Trade routes, market crashes, prosperity |
| Military | Wars, invasions, military campaigns |
| Natural | Disasters, plagues, celestial events |
| Magical | Wild magic surges, planar incursions |
| Religious | Divine interventions, cult activities |
| Social | Festivals, riots, migrations |
| Conspiracy | Hidden plots affecting the world |
| Threat | Monsters, villains, external dangers |

#### Multi-Stage Events
Events progress through stages over time:

- **Stage tracking**: Events have defined stages with descriptions
- **Duration**: Expected duration in game days
- **Deadline**: Time-sensitive events have deadlines
- **Automatic progression**: Events advance based on elapsed time

#### Event Scope & Impact
- **Scope levels**: Local, regional, continental, global
- **Affected locations**: Which locations feel the impact
- **Affected factions**: Which factions are involved
- **Triggered by**: Can be triggered by factions, characters, or other events
- **Chain reactions**: Events can spawn new events

#### Event Visibility
- **Public events**: Everyone knows about them
- **Rumored events**: Whispers and hints
- **Secret events**: Must be discovered
- **Character discovery**: Characters can uncover hidden events

#### Event Outcomes
- **Possible outcomes**: List of ways events can resolve
- **Player intervention options**: Ways characters can affect the event
- **Outcome description**: What happened when the event concluded

#### Event Effects
Specific effects that events create:

| Effect Type | Description |
|-------------|-------------|
| Price modifier | Affects goods prices at locations |
| Danger modifier | Changes location danger levels |
| Access restriction | Blocks travel or entry |
| Resource change | Affects faction or location resources |
| NPC status | Changes NPC availability or disposition |
| Custom | Flexible effect with parameters |

**Effect Properties**:
- Target type and ID (location, faction, character, etc.)
- Parameters (JSON for flexible configuration)
- Duration and expiration
- Can be reversed with reason tracking

#### Tick Processing
- Events automatically progress through stages
- Deadlines are enforced (events resolve when deadline passes)
- Effects are automatically expired when their time is up

---

### 16. Travel System

#### Journey Management
Track travel between locations with full journey mechanics:

- **Journey properties**:
  - Origin and destination locations
  - Travel method (walking, riding, ship, flying, etc.)
  - Route type (road, trail, wilderness, mountain, sea, etc.)
  - Distance and estimated travel time
  - Traveling companions
  - Game time tracking (start day/hour)

#### Travel Methods & Speeds

| Travel Method | Miles per Hour | Notes |
|---------------|----------------|-------|
| Walking | 3 mph | Standard travel |
| Forced March | 4 mph | Exhausting pace |
| Riding | 6 mph | Horseback |
| Fast Riding | 8 mph | Galloping |
| Carriage | 4 mph | Comfortable but slow |
| Boat | 5 mph | River/lake travel |
| Ship | 8 mph | Sea travel |
| Flying | 10 mph | Magical flight |
| Teleportation | Instant | Magical transport |

#### Route Modifiers

| Route Type | Time Multiplier | Description |
|------------|-----------------|-------------|
| Road | 1.0x | Well-maintained paths |
| Trail | 1.3x | Cleared but rough |
| Wilderness | 2.0x | No path, difficult terrain |
| Mountain | 2.5x | Steep and treacherous |
| Swamp | 3.0x | Most difficult terrain |
| Desert | 1.8x | Open but harsh |
| River/Sea | 1.0x | Water travel |
| Underground | 2.0x | Caves and tunnels |

#### Journey Encounters
Random encounters that occur during travel:

| Encounter Type | Description | Danger Range |
|----------------|-------------|--------------|
| Combat | Hostile creatures or bandits | 3-8 |
| Creature | Wildlife encounters | 2-6 |
| Travelers | Fellow travelers on the road | 1-3 |
| Merchant | Trading caravans | 1-2 |
| Weather | Storms, extreme conditions | 2-5 |
| Obstacle | Blocked roads, collapsed bridges | 2-4 |
| Discovery | Hidden locations, treasure | 1-3 |
| Omen | Strange signs, portents | 1-2 |

**Encounter Properties**:
- Type and danger level
- Challenge type (combat, social, survival, exploration, arcane)
- Approach chosen (fight, negotiate, flee, sneak)
- Outcome (victory, defeat, avoided, escaped)
- Consequences (HP change, gold, items, time lost)
- Can create story threads

#### Resource Consumption
- **Rations tracking**: Party size Ã— travel days
- **Gold spent**: Travel costs for transport
- **Time management**: Hours into journey tracking

#### Journey Outcomes
- **Completed**: Arrived at destination successfully
- **Aborted**: Journey cancelled, returned or stranded
- **Encounter stats**: Track encounters faced vs avoided

#### NPC Relationship Enhancements
Enhanced relationship tracking with NPCs:

**Rumor System**:
- Track rumors heard about NPCs
- Rumors can be believed or disproven
- Affects how character perceives NPC

**Promise System**:
- Track promises made to/by NPCs
- Status: pending, fulfilled, broken
- Breaking promises damages reputation (-15 disposition)
- Fulfilling promises improves standing (+10 disposition)

**Debt System**:
- Track debts owed to/by NPCs
- Types: gold, favor, life_debt, service
- Status: outstanding, settled, forgiven
- Settling debts improves relations (+10 disposition)
- Being forgiven a debt creates gratitude (+5 disposition)

#### Travel UI (TravelPage Component)

The TravelPage provides a comprehensive interface for managing journeys:

**Left Panel - Journey Management**:
- Journey list with filter tabs (Active/Completed/All)
- Journey cards showing:
  - Route (origin â†’ destination)
  - Status badges with color coding
  - Traveler name, distance, travel method
  - Progress bar for active journeys
- New journey form:
  - Character, origin, and destination selection
  - Distance and danger level inputs
  - Travel method and route type dropdowns
  - Starting rations and gold settings

**Travel Calculator**:
- Quick estimation without starting a journey
- Inputs: distance, party size, travel method, route type
- Outputs: estimated hours/days, rations needed, gold cost

**Right Panel - Journey Details**:
- Complete route and traveler information
- Distance, method, route type, danger level display
- Progress tracking (elapsed vs estimated hours)
- Resource display with consumption buttons:
  - -1 Ration button
  - -5 Gold button
- Action buttons:
  - Complete Journey (for active journeys)
  - Abort Journey (for active journeys)
- Outcome description (for completed journeys)

**Encounters Section**:
- Lists all encounters for the selected journey
- Encounter type icons: combat (âš”ï¸), social (ðŸ’¬), environmental (ðŸŒ²), discovery (ðŸ”), rest (ðŸ•ï¸), merchant (ðŸ’°), weather (ðŸŒ§ï¸), wildlife (ðŸº)
- Status badges (pending/resolved/avoided)
- Action buttons for pending encounters:
  - Fight (combat approach)
  - Negotiate (diplomacy approach)
  - Flee (stealth avoidance)

**API Integration**:
- `GET /api/travel/campaign/:campaignId` - Load journeys
- `GET /api/travel/constants` - Load travel constants
- `GET /api/travel/:journeyId/encounters` - Load encounters
- `POST /api/travel` - Start journey
- `POST /api/travel/:id/complete` - Complete journey
- `POST /api/travel/:id/abort` - Abort journey
- `POST /api/travel/:id/consume-resources` - Use resources
- `POST /api/travel/calculate/time` - Calculate travel time
- `POST /api/travel/encounter/:id/resolve` - Resolve encounter
- `POST /api/travel/encounter/:id/avoid` - Avoid encounter

#### NPC Relationships UI (NPCRelationshipsPage Component)

The NPCRelationshipsPage provides a comprehensive interface for managing NPC relationships:

**Summary Bar**:
- Quick counts of Allies, Neutral, and Hostile NPCs
- Pending promises and outstanding debts counters

**Left Panel - NPC List**:
- All NPCs the character has met
- Filter tabs: All, Allies, Neutral, Hostile
- NPC cards showing:
  - Disposition label badge (hated/hostile/unfriendly/neutral/friendly/helpful/devoted)
  - Times met and first met date
  - Disposition bar (visual -100 to +100)
  - Trust meter (10-dot display)

**Right Panel - Detail Tabs**:

*Info Tab*:
- Disposition score with adjustment buttons (+10, +5, -5, -10)
- Trust level with adjustment buttons (+1, -1)
- Stats grid: Times Met, Witnessed Deeds, Secrets Known, Pending Promises

*Promises Tab*:
- List of promises made to/by NPC
- Status badges (pending/fulfilled/broken)
- Fulfill and Break buttons for pending promises
- Fulfilling improves disposition (+10), breaking damages it (-15)

*Debts Tab*:
- Debts owed to NPC or owed by NPC
- Debt types: gold, favor, life_debt, service
- Status badges (outstanding/settled/forgiven)
- Settle Debt button for outstanding debts

*Knowledge Tab*:
- Secrets discovered (dark themed)
- Known facts (green themed)
- Rumors heard with Disprove option

**API Integration**:
- `GET /api/npc-relationship/character/:characterId` - Load relationships
- `GET /api/npc-relationship/character/:characterId/summary` - Load summary
- `GET /api/npc-relationship/character/:characterId/promises` - Load promises
- `GET /api/npc-relationship/character/:characterId/debts` - Load debts
- `POST /api/npc-relationship/:characterId/:npcId/disposition` - Adjust disposition
- `POST /api/npc-relationship/:characterId/:npcId/trust` - Adjust trust
- `POST /api/npc-relationship/:characterId/:npcId/promise/:index/fulfill` - Fulfill promise
- `POST /api/npc-relationship/:characterId/:npcId/promise/:index/break` - Break promise
- `POST /api/npc-relationship/:characterId/:npcId/debt/:index/settle` - Settle debt
- `POST /api/npc-relationship/:characterId/:npcId/rumor/:index/disprove` - Disprove rumor

#### Living World UI (LivingWorldPage Component)

The LivingWorldPage provides a comprehensive dashboard for managing the living world simulation:

**Summary Cards**:
- Active Factions, Active Goals, Active Events, Active Effects counts

**Left Panel - World Controls**:

*Advance Time*:
- Process 1-7 days of world progression
- Shows: goals processed, events spawned, effects expired

*Simulate Time Skip*:
- Simulate 1-30 days for "what if" scenarios
- Summary: goals advanced/completed, events spawned, effects expired

*AI Content Generation*:
- Generate faction goals (select faction, auto-create)
- Generate world events (optional type filter, auto-create)
- Results display for generated content

**Right Panel - World State with Tabs**:

*Overview Tab*:
- Character's visible world view statistics
- Recent activity log (goals, events)

*Factions Tab*:
- All factions with power levels
- Active goal counts and progress bars

*Events Tab*:
- All events with type color-coding
- Stage progress and status

*Effects Tab*:
- All active effects with targets
- Expiration dates

**API Integration**:
- `GET /api/living-world/state/:campaignId` - Load world state
- `GET /api/living-world/character-view/:characterId` - Load character view
- `POST /api/living-world/tick/:campaignId` - Process tick
- `POST /api/living-world/simulate/:campaignId` - Simulate days
- `POST /api/living-world/generate/faction-goal/:factionId` - Generate goal
- `POST /api/living-world/generate/world-event/:campaignId` - Generate event

#### Campaign Management UI (CampaignsPage Component)

The CampaignsPage provides a comprehensive interface for managing campaigns:

**Left Panel - Campaign List**:
- All campaigns with filter tabs (Active/Archived/All)
- Campaign cards showing:
  - Name and description
  - Setting and tone badges
  - Status (active/archived)
  - Character count
- New campaign form:
  - Name and description
  - Setting input (defaults to Forgotten Realms)
  - Tone selection dropdown (Heroic Fantasy, Dark Fantasy, Comedic, Survival, etc.)
  - Starting location dropdown grouped by Major Cities / Regions + Custom option
  - Auto-select from parsed backstory with "(from backstory)" indicator
  - Time ratio selection (Realtime, Leisurely, Normal, Fast, Montage)
- **Auto-Pipeline**: On submission, runs create â†’ assign â†’ parse backstory â†’ generate campaign plan
- **Pipeline Progress UI**: Step indicators with checkmarks, active spinner, animated progress bar during generation
- **Play Now / Back to Campaigns**: Buttons appear when pipeline completes

**Right Panel - Campaign Details**:
- Full campaign information display
- Stats grid: Characters, Quests, Locations
- Starting location
- Character assignment section:
  - List of assigned characters with remove option
  - Dropdown to assign new characters
- Archive campaign action

**API Integration**:
- `GET /api/campaign` - Load campaigns
- `GET /api/campaign/:id/stats` - Load statistics
- `GET /api/campaign/:id/characters` - Load assigned characters
- `GET /api/character` - Load all characters
- `POST /api/campaign` - Create campaign
- `PUT /api/campaign/:id` - Update campaign
- `POST /api/campaign/:id/archive` - Archive campaign
- `DELETE /api/campaign/:id` - Delete campaign (hard delete with cascade)
- `POST /api/campaign/:id/assign-character` - Assign character
- `DELETE /api/campaign/:campaignId/character/:characterId` - Remove character
- `GET /api/campaign/:id/plan` - Get campaign plan
- `POST /api/campaign/:id/plan/generate` - Generate plan with Claude Opus
- `GET /api/campaign/:id/plan/summary` - Get condensed plan summary
- `PUT /api/campaign/:id/plan/:section` - Update plan section
- `POST /api/campaign/:id/plan/world-event` - Add world event to plan
- `POST /api/campaign/:id/plan/npc` - Add NPC to plan

#### Quest Tracker UI (QuestsPage Component)

The QuestsPage provides a comprehensive interface for tracking quests:

**Left Panel - Quest List**:
- All quests with filter tabs (Active/Completed/Failed/All)
- Quest cards showing:
  - Quest type icons (Main ðŸ‘‘, Side ðŸ“œ, Companion ðŸ‘¤, One-Time âš¡)
  - Type, status, and priority badges
  - Stage progress (Stage X of Y)
  - Progress bar for active quests

**Right Panel - Quest Details with Tabs**:

*Info Tab*:
- Quest metadata (type, status, priority)
- Premise/description block
- Antagonist info (if applicable)
- Deadline warning for time-sensitive quests
- Actions: Advance Stage, Complete Quest, Fail Quest, Abandon

*Stages Tab*:
- Visual stage progression with color indicators
- Current stage highlighted in blue
- Completed stages in green
- Requirements for each stage with checkboxes
- Click to manually complete requirements

*Rewards Tab*:
- XP, Gold, Items, Reputation rewards
- World impact on completion
- Escalation consequences if ignored

**API Integration**:
- `GET /api/quest/character/:characterId` - Load quests
- `GET /api/quest/:questId/requirements` - Load requirements
- `POST /api/quest/:id/advance` - Advance stage
- `POST /api/quest/:id/complete` - Complete quest
- `POST /api/quest/:id/fail` - Fail quest
- `POST /api/quest/:id/abandon` - Abandon quest
- `POST /api/quest/requirement/:id/complete` - Complete requirement

#### Locations UI (LocationsPage Component)

The LocationsPage provides a comprehensive interface for managing locations:

**Left Panel - Location List**:
- All locations with search box
- Filter tabs (All/Discovered/Visited)
- Type filter dropdown
- Location cards showing:
  - Type icons (ðŸ™ï¸ city, ðŸ˜ï¸ town, ðŸšï¸ dungeon, etc.)
  - Danger level indicators
  - Discovery status badges
  - Region names
- Create new location form

**Right Panel - Location Details with Tabs**:

*Info Tab*:
- Type, danger level, region info
- Description block
- Services and tags lists
- Visit statistics

*Connections Tab*:
- Connected locations with travel times
- Route types (road, trail, etc.)
- Click to navigate to connected locations

*Status Tab*:
- Current discovery status
- Status update buttons
- Current state information
- "Mark as Discovered" action

**API Integration**:
- `GET /api/location/campaign/:campaignId` - Load locations
- `GET /api/location/:id/connections` - Load connections
- `POST /api/location` - Create location
- `POST /api/location/:id/discover` - Discover location
- `PUT /api/location/:id/discovery-status` - Update status

#### Companion Backstory UI (CompanionBackstoryPage Component)

The CompanionBackstoryPage provides an interface for viewing and managing companion backstories:

**Left Panel - Companion List**:
- All companions for the character
- Companion cards showing:
  - Avatar and name
  - Race and class
  - Level

**Right Panel - Backstory Details with Tabs**:

*Story Tab*:
- Personal history/summary narrative
- Origin description
- Motivation information
- Key relationships list

*Threads Tab*:
- Unresolved story threads
- Thread status icons (ðŸ”¥ active, ðŸ“– developing, âœ… resolved, âŒ abandoned)
- Status dropdown to update thread status
- Descriptions with story hooks
- Add Thread button for AI generation

*Secrets Tab*:
- Hidden secrets (blurred until revealed)
- Secret category badges
- Reveal Secret button
- Potential impact information
- Add Secret button for AI generation

**Backstory Generation**:
- Generate Backstory button when none exists
- Regenerate button to create new backstory
- Thread and secret AI generation

**API Integration**:
- `GET /api/companion/character/:characterId` - Load companions
- `GET /api/companion/:id/backstory` - Load backstory
- `POST /api/companion/:id/backstory/generate` - Generate backstory
- `POST /api/companion/:id/backstory/threads` - Add threads
- `POST /api/companion/:id/backstory/secret` - Generate secret
- `PUT /api/companion/:id/backstory/thread/:threadId` - Update thread
- `POST /api/companion/:id/backstory/secret/:secretId/reveal` - Reveal secret

#### Narrative Queue UI (NarrativeQueuePage Component)

The NarrativeQueuePage provides an interface for managing pending story events:

**Summary Bar**:
- Urgent/High/Normal counts
- Total pending items

**Left Panel - Queue List**:
- Tabs for Pending and History
- Priority filter dropdown
- Add manual item form
- Item cards showing:
  - Event type icons (âš”ï¸ adventure, ðŸ“œ quest, ðŸ’¬ companion, etc.)
  - Title and priority badges (color-coded)
  - Description preview
  - Timestamps
- Bulk "Mark All as Delivered" action

**Add Item Form**:
- Event type selection
- Priority selection (urgent/high/normal/low/flavor)
- Title and description inputs

**Right Panel - Item Details**:
- Event type and status display
- Created/delivered timestamps
- Full description and context
- Related entities (quest, location, companion, NPC)
- Actions: Mark as Delivered, Delete

**API Integration**:
- `GET /api/narrative-queue/:characterId` - Load pending items
- `GET /api/narrative-queue/:characterId/history` - Load history
- `POST /api/narrative-queue` - Add item
- `POST /api/narrative-queue/deliver` - Mark delivered
- `DELETE /api/narrative-queue/:itemId` - Delete item

#### Generation Controls UI (GenerationControlsPage Component)

The GenerationControlsPage provides a centralized interface for triggering AI content generation:

**Left Panel - Generation Categories**:
- Quest Generation
- Location Generation
- World Content
- Companion Backstories

**Main Panel - Generation Options**:

*Quest Generation*:
- Quest type selection (Main Quest, Side Quest, One-Time, Companion)
- Theme input for quest flavor
- Generate button with loading state
- Displays generated quest details on success

*Location Generation*:
- Generation type (Single, Region, Dungeon)
- Location type dropdown (city, town, dungeon, ruins, etc.)
- Danger level selector (1-10)
- Theme input
- Generate button

*World Content*:
- Faction goal generation (select faction from dropdown)
- World event generation (optional type filter)
- Generate buttons for each type

*Companion Backstories*:
- List of companions without backstories
- Generate Backstory button for each
- Shows backstory summary on success

**Right Panel - Results Display**:
- Generated content details
- Quest: title, type, premise, stages, rewards
- Location: name, type, description, danger, connections
- World content: goal/event details
- Backstory: origin, motivation, threads, secrets

**API Integration**:
- `POST /api/quest/generate/main` - Generate main quest
- `POST /api/quest/generate/side` - Generate side quest
- `POST /api/quest/generate/one-time` - Generate one-time quest
- `POST /api/quest/generate/companion/:companionId` - Generate companion quest
- `POST /api/location/generate` - Generate location
- `POST /api/location/generate/region` - Generate region
- `POST /api/location/generate/dungeon` - Generate dungeon
- `POST /api/living-world/generate/faction-goal/:factionId` - Generate faction goal
- `POST /api/living-world/generate/world-event/:campaignId` - Generate world event
- `POST /api/companion/:id/backstory/generate` - Generate backstory

---

### 17. Living World System

#### Tick Processing
The living world advances automatically when game time passes:

- **Faction Goal Advancement**: Goals progress based on faction power level, urgency, and inter-faction dynamics
- **Faction Interference**: Hostile factions slow each other's goals; allied factions boost each other
- **Random Disruptions**: 8% chance per goal per day of setbacks (lose 10-30% progress)
- **Random Breakthroughs**: 5% chance per goal per day of bonus progress (50-100% extra)
- **Wider Variance**: Progress varies 0.5x to 1.5x per tick (not deterministic)
- **World Event Progression**: Events advance through stages
- **Effect Expiration**: Temporary effects expire when their duration ends
- **Deadline Enforcement**: Time-sensitive events resolve when deadlines pass

#### Automatic Event Spawning
World events are automatically created when faction goals reach milestones:

| Milestone | Event Type | Visibility |
|-----------|------------|------------|
| 25% progress | Faction makes progress | Depends on goal visibility |
| 50% progress | Faction gains momentum | At least rumored |
| 75% progress | Faction nears goal | At least rumored |
| 100% complete | Goal achieved | Public if major stakes |

#### Rival Faction Reactions
When a faction reaches 50%+ on a goal, rival factions may react:
- Hostile/enemy/rival factions have a 40% chance of spawning counter-events
- Counter-events create opposing operations with their own stages and player intervention options
- Creates emergent faction-vs-faction conflict without scripting

#### Power Shifts on Goal Completion
When a faction completes a goal, their power level increases based on stakes:
- **Major stakes**: +1 power level
- **Catastrophic stakes**: +2 power level
- Power shifts create event effects tracked in the world state

#### AI Content Generation
Generate dynamic content for the living world:

**Faction Goals**:
- Match faction identity, values, and methods
- Types: expansion, defense, economic, political, military, covert, religious, magical
- Include success/failure consequences
- Player intervention hooks

**World Events**:
- Types: political, economic, military, natural, magical, religious, social, conspiracy, threat
- Multi-stage progression
- Player intervention options
- Effects on locations and factions

#### World State Queries
- **Campaign-wide state**: All factions, goals, events, effects
- **Character view**: Only what the character can see
  - Public events
  - Discovered events
  - Known faction goals
  - Faction standings

#### Time Integration
When game time advances (via adventures, downtime, or manual skips):
1. Living world tick is processed
2. Faction goals advance
3. World events progress
4. Milestone events spawn
5. Results returned to player

---

### 18. AI Content Generation

#### Quest Generator
Generates complete quests with AI (Claude primary, Ollama fallback):

- **Main Quest Generation**: Epic 5-stage storylines with antagonists
- **Side Quest Generation**: Focused 2-3 stage adventures
- **One-Time Quest Generation**: Single objectives (bounty, rescue, delivery, retrieval, exploration)
- **Companion Quest Generation**: Personal quests tied to backstory threads

Output includes:
- Quest metadata (title, premise, urgency, rewards)
- Stage definitions with names and descriptions
- Abstract requirements for each stage
- Related NPCs and locations

#### Location Generator
Generates detailed locations for the game world:

- **Region Generation**: Create multiple thematically-linked locations
- **Single Location Generation**: Detailed location with NPCs and adventure hooks
- **Dungeon Generation**: Adventure sites with hazards, inhabitants, treasure
- **Connection Generation**: Travel routes between locations

Output includes:
- Location details (name, type, description, danger level)
- Notable NPCs present
- Adventure hooks and secrets
- Connected locations and travel routes

#### Companion Backstory Generator
Generates rich backstories for recruited companions:

- **Full Backstory Generation**: Origin, formative event, motivation, personality
- **Thread Generation**: Create additional unresolved threads
- **Secret Generation**: Generate specific secret types

Output includes:
- Complete life history
- 2-4 unresolved threads with activation triggers
- 1-2 secrets with loyalty thresholds
- Loyalty triggers (positive and negative)

---

## Technical Architecture

| Layer | Technology |
|-------|------------|
| Frontend | React (Vite) with lazy loading |
| Backend | Express.js |
| Database | SQLite / Turso (cloud) |
| AI Providers | Claude API (Claude Opus + Claude Sonnet), Ollama (local) |
| Deployment | Works offline with Ollama only |

### Bundle Optimization
- **13 components lazy-loaded** with `React.lazy()` + `Suspense`
- **Main bundle**: ~971 kB (244 kB gzipped) â€” down from 1,321 kB
- **DMSession** (101 kB) and **CampaignPlanPage** (27 kB) loaded on demand
- **11 hidden pages** (222 kB combined) split into separate chunks
- **ErrorBoundary** wraps the Suspense boundary to catch render crashes with a "Try Again" button

### Home Page â€” Navigation Hub

The home page serves as a central hub with:
- **Green Play button** at the top (visible when campaign plan is ready) â€” one click to launch DM session
- **Character selector** for switching between characters
- **Navigation cards** in a responsive grid â€” each card has a color accent, label, and description explaining what the feature does

Navigation cards:
| Card | Description |
|------|-------------|
| Character Sheet | View stats, equipment, abilities, and level up |
| Companions | Manage your companion characters and their stories |
| Backstory Parser | AI-parse your backstory into structured elements |
| Campaigns | Create campaigns with auto-generated world plans |
| Campaign Plan | View your campaign world, NPCs, factions, and quests |
| AI Dungeon Master | Play through your campaign with an AI DM |
| Downtime & Stats | Rest, train, generate adventures, and track progress |
| Settings | Configure character preferences and options |

### Dropdown Navigation (Sub-pages)

When on a sub-page, dropdown menus in the header provide quick navigation:

| Category | Features |
|----------|----------|
| **Character** | Character Sheet, Companions, Backstory Parser, Downtime & Stats, Settings |
| **Story** | Campaigns, Campaign Plan |
| **Play** | AI Dungeon Master |

**Hidden pages** (code exists for future reintegration / offline play): Locations, Factions, Travel, World Events, Living World, Narrative Queue, NPC Generator, NPC Relationships, Quests, Companion Backstories, Campaign Stats, Generate Content â€” these are now covered by the Campaign Plan system, gameplay tabs, or the Downtime & Stats combined page.

### Downtime & Stats Page

A combined page bringing together all between-session activities:
- **Downtime activities** (rest, work, train) â€” left column
- **Adventure system** (generate/active adventures) â€” right column
- **MetaGameDashboard** (campaign stats, time advancement) â€” full width
- **Adventure History** (past adventure log) â€” full width

### Gameplay Tabs

During active DM sessions, a tab bar provides access to three views:
- **Adventure** â€” Main gameplay with message display and action input
- **Downtime** â€” Embedded Downtime component for rest, work, and training activities
- **Stats** â€” Embedded MetaGameDashboard for campaign statistics and time management

Tabs reset to "Adventure" when a new session starts.

**Navigation Components**:
- `NavigationMenu.jsx` - Dropdown menu component with category groupings
- `App.jsx` - Single `activeView` state manages which page is displayed
- Home button appears when viewing any sub-page

**State Management**:
- Uses React's `useState` for simple boolean navigation
- Single `activeView` state replaces multiple `show*` boolean flags
- `navigateTo(view)` and `goHome()` helper functions for clean navigation

### Error Handling

The API uses a standardized error response utility (`server/utils/errorHandler.js`):

| Function | Purpose | HTTP Status |
|----------|---------|-------------|
| `handleServerError(res, error, context)` | Log and return server errors | 500 |
| `notFound(res, resource)` | Resource not found | 404 |
| `validationError(res, message)` | Validation failures | 400 |

**Error Codes**: `NOT_FOUND`, `VALIDATION_ERROR`, `DATABASE_ERROR`, `INTERNAL_ERROR`, `CONFLICT`

### Database Tables

**Core Tables**:
- **characters**: Full character data with 50+ columns
- **adventures**: Adventure instances and results
- **dm_sessions**: Text adventure sessions
- **downtime**: Downtime activity logs
- **companions**: Recruited NPC companions
- **npcs**: NPC database
- **story_threads**: Plot hooks and campaign consequences
- **activity_queue**: Scheduled activities for meta game
- **adventure_options**: Cache for generated adventures

**Narrative System Tables**:
- **campaigns**: Campaign configuration and settings
- **quests**: Quest definitions with metadata
- **quest_stages**: Sequential stages within quests
- **quest_requirements**: Abstract requirements for stages
- **locations**: Detailed location data
- **location_connections**: Travel routes between locations
- **companion_backstories**: Rich backstory data for companions
- **narrative_queue**: Story events awaiting delivery to DM sessions

**Merchant System Tables**:
- **merchant_inventories**: Persistent merchant inventories (campaign_id, name, type, inventory JSON, gold_gp)

**Expansion System Tables**:
- **factions**: Organizations with identity, power, resources, values
- **faction_goals**: Goals factions pursue with progress tracking
- **faction_standings**: Character standings with factions
- **world_events**: Multi-stage events affecting the world
- **event_effects**: Specific effects from world events
- **journeys**: Travel between locations with companions and resources
- **journey_encounters**: Encounters during travel with outcomes

### API Routes

**Core Routes**:
- `/api/character` - Character CRUD, progression, parsed backstory, discard-item
- `/api/adventure` - Meta adventure system
- `/api/dm-session` - AI DM sessions (see detailed endpoints below)
- `/api/downtime` - Downtime activities
- `/api/companion` - Companion management
- `/api/npc` - NPC database
- `/api/meta-game` - Campaign context and time management
- `/api/story-threads` - Story thread CRUD
- `/api/upload` - File uploads (avatars)

**DM Session Endpoints** (`/api/dm-session`):
- `GET /llm-status` - Check AI provider status
- `GET /models` - List available AI models
- `GET /active/:characterId` - Get active session for character
- `GET /history/:characterId` - Get session history
- `GET /campaign-context/:characterId` - Get campaign plan summary + character state
- `GET /:sessionId` - Get session details
- `POST /start` - Start new session (with campaign plan context injection)
- `POST /:sessionId/message` - Send player action (returns narrative + downtime/recruitment/combat/loot detection)
- `POST /item-rarity-lookup` - Batch item rarity lookup for inventory display
- `POST /:sessionId/adjust-date` - Advance in-game calendar
- `POST /:sessionId/inject-context` - Inject system note (e.g., after manual downtime)
- `POST /:sessionId/end` - End session (generates rewards, summary)
- `POST /:sessionId/pause` - Pause session
- `POST /:sessionId/resume` - Resume paused session
- `POST /:sessionId/abort` - Abort session
- `POST /:sessionId/claim` - Claim session rewards
- `POST /:sessionId/apply-inventory` - Apply inventory changes from session
- `POST /:sessionId/extract-npcs` - Extract NPCs mentioned in session
- `POST /character/:characterId/extract-all-npcs` - Extract NPCs from all sessions
- `DELETE /:sessionId` - Delete a session
- `DELETE /character/:characterId/history` - Clear session history

**Narrative System Routes**:
- `/api/campaign` - Campaign CRUD and statistics
- `/api/quest` - Quest management, stages, and requirements
- `/api/location` - Location CRUD, discovery, and connections
- `/api/narrative-queue` - Narrative queue management

**Expansion System Routes**:
- `/api/faction` - Faction CRUD, goals, standings, and tick processing
- `/api/world-event` - World event CRUD, effects, and tick processing
- `/api/travel` - Journey management, encounters, and travel calculations
- `/api/npc-relationship` - NPC relationships, rumors, promises, and debts
- `/api/living-world` - Living world tick, state queries, AI generation, simulation

---

## Key User Flows

### Flow 0: Streamlined New Campaign (Recommended)
```
Create character â†’ Write backstory (optional) â†’ Create Campaign â†’ Auto-pipeline (assign + parse + generate) â†’ Play Now â†’ Adventure!
```

### Flow 1: Meta Adventure Loop
```
Create character â†’ Generate adventures â†’ Start adventure â†’ Wait for completion â†’ Claim rewards â†’ Story threads created
```

### Flow 2: Interactive DM Session
```
Play button (home) or Navigate to AI DM â†’ Start session â†’ Opus campaign plan injected into Sonnet's system prompt â†’ Interactive roleplay with enforced combat/NPC rules â†’ Switch to Downtime/Stats tabs mid-session (changes injected back into AI context) â†’ Session ends â†’ Claim rewards â†’ Campaign notes updated
```

### Flow 3: Downtime Management
```
Do downtime (standalone or via DM session tab) â†’ Benefits applied to character â†’ If mid-session, context injected into AI conversation â†’ Advance time â†’ Events feed into next DM session
```

### Flow 4: Party Building
```
Recruit companion â†’ Include in adventures â†’ Party synergy improves odds â†’ Companion levels up
```

### Flow 5: Quest Progression (Enhanced)
```
Quest generated â†’ Requirements defined abstractly â†’ Game events check progress â†’ Stage advances when requirements met â†’ Final stage completes quest â†’ Rewards granted
```

### Flow 6: Location Discovery
```
Location rumored â†’ Character visits area â†’ Location discovered â†’ One-time quest generated (if dangerous) â†’ Exploration unlocks secrets
```

### Flow 7: Companion Backstory Integration
```
Recruit companion â†’ Backstory auto-generated â†’ Threads dormant â†’ Trigger conditions met â†’ Thread activates â†’ Added to narrative queue â†’ DM weaves into session
```

### Flow 8: Narrative Queue Delivery
```
Game event occurs â†’ Event added to narrative queue â†’ DM session starts â†’ Queue formatted for AI context â†’ DM incorporates into narrative â†’ Items marked delivered
```

### Flow 9: Faction Reputation
```
Help/hinder faction â†’ Standing modified â†’ Deeds recorded â†’ Standing label updates â†’ At high standing, join faction â†’ Unlock faction benefits
```

### Flow 10: Faction Goal Discovery
```
Faction pursues goal secretly â†’ Character investigates â†’ Goal discovered â†’ Added to character's known goals â†’ Can help or hinder â†’ Goal progress affects world
```

### Flow 11: World Event Progression
```
Event triggered â†’ Starts at stage 0 â†’ Time passes â†’ Stage advances â†’ Effects applied â†’ Event resolves â†’ Outcome affects world state
```

### Flow 12: Living World Tick
```
Game time advances â†’ Faction tick processed â†’ Goals progress â†’ World event tick processed â†’ Events advance stages â†’ Effects expire â†’ World state updated
```

### Flow 13: Journey Travel
```
Start journey â†’ Travel time calculated â†’ Encounter checks made â†’ Encounters resolved or avoided â†’ Resources consumed â†’ Journey completes â†’ Arrive at destination
```

### Flow 14: NPC Promise/Debt
```
Make promise to NPC â†’ Promise tracked â†’ Fulfill or break promise â†’ Disposition updated â†’ Relationship affected â†’ Future interactions impacted
```

---

## Summary

This is a **solo D&D campaign manager** with a **two-stage AI pipeline**:

**Claude Opus** builds the world (campaign plans, backstory parsing, NPC/quest/location/companion generation, living world events, adventures) â†’ **Claude Sonnet** runs interactive DM sessions (narration, combat, dialogue with enforced D&D 5e rules). Both models use alias IDs (no date suffix) so they auto-update to the latest version.

### Core Gameplay Loop
1. **Create a character** with backstory â†’ **Create a campaign** (auto-pipeline: assign + parse backstory + generate world plan) â†’ **Play** via the green Play button
2. **AI DM sessions** with Claude Sonnet â€” full combat mechanics (initiative, attack rolls, damage), NPC question pausing, narrative consistency
3. **Downtime** between sessions (or mid-session via tabs) â€” rest, train, craft, work for gold
4. **Campaign plan** guides the story â€” Sonnet follows Opus's quest arc, NPCs, and world state

### Full Feature Set
1. **Start an adventure** and come back later when it's done
2. **Dive into interactive AI DM sessions** when you have time for deeper roleplay
3. **Manage downtime** between adventures with class-specific activities
4. **Build a party** of companions who contribute to your success
5. **Track persistent story consequences** that carry across sessions
6. **Progress through multi-stage quests** with abstract requirements satisfied by gameplay
7. **Explore a living world** with discoverable locations and travel connections
8. **Experience companion depth** through AI-generated backstories, secrets, and personal plot threads
9. **Engage with factions** that pursue their own goals and react to your actions
10. **Witness world events** that progress over time and shape the campaign
11. **Travel between locations** with realistic journey mechanics, encounters, and resource management
12. **Build NPC relationships** with tracked rumors, promises, and debts

### Architecture
The system seamlessly integrates structured meta-game mechanics (adventures, downtime, rewards) with freeform AI-powered narrative sessions. An **event-driven narrative system** connects all game actions to consequences, automatically checking quest progress, activating companion storylines, and queuing story events for delivery during DM sessions. DM sessions emit gameplay events at session end (NPC interactions, location visits, item gains), connecting freeform AI gameplay to the structured quest and companion systems.

**Living World Systems** enable factions to pursue goals over time and world events to unfold and affect locations, creating a dynamic game world that evolves even when the player isn't actively engaged. Tick processing advances faction goals with emergent behavior: hostile factions interfere with each other's progress, allied factions provide boosts, and random disruptions/breakthroughs add unpredictability. Rival factions spawn counter-events when opponents reach significant milestones, and completing goals shifts faction power levels.

**Campaign Plan System** uses Claude Opus to generate comprehensive world plans (main quest with 3-act structure, 6-8 NPCs, factions, locations, side quests, DM notes). The plan is condensed via `getPlanSummaryForSession()` and injected into Sonnet's system prompt, ensuring the AI DM follows the established story rather than improvising a new one. The `campaignFoundationPrompt` is conditional â€” it tells Sonnet to use the plan when one exists, or create its own story framework when playing without a plan.

**AI DM Prompt Engineering**: The ~600-line system prompt (`server/services/dmPromptBuilder.js`) uses primacy/recency reinforcement â€” critical rules appear both at the beginning (ABSOLUTE RULES) and end (FINAL REMINDER) of the prompt, since LLMs attend most strongly to the start and end of their context. Rules cover combat mechanics, NPC question pausing, narrative consistency, and D&D 5e mechanics. A **world state snapshot** (`formatWorldStateSnapshot()`) is injected between the campaign plan and story threads, providing the AI DM with current faction standings, active world events, NPC relationships (with promises/debts/secrets), known faction goals, and discovered locations â€” all compressed with hard caps (6+5+8+4+8 max entries) and string truncation to stay within ~250-500 tokens. Session orchestration (start/continue/summarize) lives in `server/services/ollama.js`, with the raw LLM client in `server/services/llmClient.js`.

AI generators (Claude primary, Ollama fallback) create quests, locations, and companion backstories on demand, ensuring fresh content while maintaining narrative coherence across the campaign.
